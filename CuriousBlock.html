<!DOCTYPE html>
<html>

<head>
    <title>Processing.JS inside Webpages: Template</title>
</head>

<body>
    <!--This draws the canvas on the webpage -->
    <canvas id="mycanvas"></canvas>
</body>

<!-- Include the processing.js library -->
<!-- See https://khanacademy.zendesk.com/hc/en-us/articles/202260404-What-parts-of-ProcessingJS-does-Khan-Academy-support- for differences -->
<script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script>
<script>
    var programCode = function (processingInstance) {
        with (processingInstance) {
            var screen_width = 800
            var screen_height = 800
            size(screen_width, screen_height);
            frameRate(60);
            //Main ProcessingJS code starts here
            //Levels:
            // - Level 1
            // - Level 2
            // - Level 3
            // - Level 4
            // - Level 5
            // - Level 6
            // - Level 7
            /*Index:
            P=Player
            b=Block
            M=Sponge
            &=Monster
            %=Shooter
            A=Spikes
            #=Lava
            _=Ice
            @=Portal
            */
            var levels = [
                //Level 1
                [
                    "                    ",
                    "                    ",
                    "                    ",
                    "               @    ",
                    "               b    ",
                    "               b    ",
                    "               bM   ",
                    "               b    ",
                    "               bM   ",
                    "               b    ",
                    "               bM  b",
                    "                  b ",
                    "bM& & &  & &  & & &b",
                    " Mb##b##b##b##b#bbbb",
                    " M                  ",
                    " M                  ",
                    " M                  ",
                    "                   P",
                    "_b_______________bbb",
                    "AAAAAAAAAAAAAAAAAAAA",
                    "bbbbbbbbbbbbbbbbbbbb",
                ],
                //Level 2
                [
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "b        &      &      &        &     b",
                    "b@       &      &      &        &     b",
                    "bbbbb    &      &      &        &     b",
                    "b   bb   &      &      &        &     b",
                    "bM  bbbb &      &      &        &     M",
                    "bM  bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb  M",
                    "bM                                    M",
                    "bM                                    M",
                    "bM                                    M",
                    "bMbbbbbbbbb    bbbb    bbbbbbb   bbbbbb",
                    "bM       %%%%%%%%%%%%%%%%%%%%%%%%%%%   ",
                    "bbbbbb                                 ",
                    "     bb                               M",
                    "M b bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb M",
                    "M b bbbb  %%%%%%%%%%%%%%%%%%%%%%%%%   M",
                    "M b bbbb                              M",
                    "M b                                   M",
                    "M bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "M                                     A",
                    "b&  &    &   &    &   &   &   &   &   b",
                    " bbbbbbbbbbbbbbbbbbbbbbbbbbb           ",
                    "                              b        ",
                    "                                M      ",
                    "                                   M   ",
                    "                                       ",
                    "                                       ",
                    " bb   bb   bb   bb    bb   bb    bb  bb",
                    "M b###################################b",
                    "M                                      ",
                    "M                                      ",
                    "M                                      ",
                    "M                                      ",
                    "                                      P",
                    "bb__________________________________bbb",
                    "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%",
                    "#######################################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
                //Level 3
                [
                    "                                                   ",
                    "                                                   ",
                    "                                                   ",
                    "                                                   ",
                    "              _                                    ",
                    "                 _                                 ",
                    "                    _  _  _                        ",
                    "############b b##############b                     ",
                    "                           ###b                    ",
                    "                            ###b                   ",
                    "                             ###b                  ",
                    "                                ###b               ",
                    "                                   ###b            ",
                    "             b b b b  bb              ###b##b      ",
                    "AAAAAAAAAAAAAAAAAAAAAAAAAb  bAAAAAAAAAAAAAAAAAAb  P",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "##########################  #######################",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbb  bbbbbbbbbbbbbbbbbbbbbbb",
                    "                                                   ",
                    "                         bbbb                      ",
                    "&    &      &       &      &     &      &    &    &",
                    "                  bbbb                             ",
                    "% % %                                         % % %",
                    "           bbbb                                    ",
                    "b&&  &&&  &&&  &&&  &&&  &&&  &&&  &&&  &&&  &&&  b",
                    "                                                   ",
                    "                                                   ",
                    "                bb                            bb   ",
                    "################################################   ",
                    "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA   ",
                    "    %    %     %    %   %   %   %   %   %    %     ",
                    "                                                   ",
                    "                                                   ",
                    "  Ab                                               ",
                    " bbb                                               ",
                    "@  b   M     M       M     M                       ",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
                //Level 4
                [
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "                                    ",
                    "                                    ",
                    "                                    ",
                    "                                    ",
                    "                                    ",
                    "                                    ",
                    "                                    ",
                    "                                    ",
                    "                     b   ###########",
                    "                     b              ",
                    "                     b              ",
                    "#      #     #      #b M            ",
                    "                     b M            ",
                    "b &&                 b M            ",
                    "   bbbbbbbbbbbbbbbbbbb M            ",
                    "                %   %b M            ",
                    "                     b M            ",
                    "bbbbbbbbbbbbbbbbbbb  b M            ",
                    "                     b M            ",
                    "b &        &       & b M            ",
                    "   bbbbbbbbbbbbbbbbbbb M            ",
                    "              %  %  %b M            ",
                    "                     b   M          ",
                    "bbbbbbbbbbbbbbbbbbb  b     M        ",
                    "b   &  &  &   &   &  b       M      ",
                    "b   &  &  &   &   &  b         _    ",
                    "     b_______________b########      ",
                    "     b###############bbbbbbbbb     _",
                    "     bbbbbbbbbbbbbbbbb%          _  ",
                    "                    %b         _   %",
                    "b&  &   &   &   &  & b%      _      ",
                    "bbbbbbbbbbbbbbbbbb   b    _        %",
                    "                     b      ########",
                    "   bbbbbbbbbbbbbbbbbbb_     bbbbbbbb",
                    "A                    b& _          b",
                    "bbbbbbbbbbbbbbbbbb   b&   _       &b",
                    "b  &        &        b&     _      b",
                    "b  &  &  &  &  &  &  b&       _   Pb",
                    "b   bbbbbbbbbbbbbbbbbb           bbb",
                    "bA                  @b#############b",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
                //Level 5
                [
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "                                          ",
                    "       b                    _             ",
                    "           b_______________b b____________",
                    "    b     bb############### @ ############",
                    "                            b             ",
                    "        b                                 ",
                    "                                          ",
                    "    b                                     ",
                    "                                          ",
                    "        b                   b             ",
                    "                                          ",
                    "             b                            ",
                    "                                          ",
                    "##################bMb#####################",
                    "bbbbbbbbbbbbbbbbbbbMbbbbbbbbbbbbbbbbbbbbbb",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "              %   bMb   %                 ",
                    "bbbbbbbbbbbbbbbbbbbMbbbbbbbbbbbbbbbbbbbbbb",
                    "                                          ",
                    "                                          ",
                    "                  bbb                     ",
                    "                                          ",
                    "                                          ",
                    "               b        b                 ",
                    "          _        _        _             ",
                    "%                                        %",
                    "                                          ",
                    "%              b        b                %",
                    "                                          ",
                    "%         _        _        _            %",
                    "                                          ",
                    "%              b        b                %",
                    "                                          ",
                    "%         _        _        _            %",
                    "                                          ",
                    "%              b        b                %",
                    "                                          ",
                    "%         _        _        _            %",
                    "                                          ",
                    "%              b        b                %",
                    "                                          ",
                    "%         _        _        _            %",
                    "                                          ",
                    "%              b        b                %",
                    "                                          ",
                    "%         _        _        _            %",
                    "                                          ",
                    "%              b        b                %",
                    "AAA                                    AAA",
                    "bbb       _        _        _          bbb",
                    "b                                        b",
                    "b b                                    b b",
                    "bMbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "bM &&      &&     &&     &&    &&    b%%b#",
                    "bM                               %b  b##b ",
                    "bM                               %b  b    ",
                    "bM                               %b _b  b ",
                    "bM                               %b#    b ",
                    "bM                               %b  b  b ",
                    "bM                               %b Mb  b ",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbM",
                    "                                         M",
                    "                                         M",
                    "                                         M",
                    "   AA   AA   AA   AA   AA   AA   AA   AA  ",
                    "Mbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "M     %         %         %          %    ",
                    "M                                         ",
                    "M                                         ",
                    "                                          ",
                    "      _      _    _    _   _              ",
                    "#######################                   ",
                    "                               _          ",
                    "                            _             ",
                    "                         _                ",
                    "                     _                    ",
                    "                                          ",
                    "                                          ",
                    "                         _                ",
                    "                             _            ",
                    "                                 _        ",
                    "                                     _    ",
                    "                                          ",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbM",
                    "               %     %     %     %        ",
                    "                                         M",
                    "                                          ",
                    "                                         M",
                    "  AAAAA                                   ",
                    "bMbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "b b                                       ",
                    "bMb                                       ",
                    "b b  b             _                      ",
                    "bMb  b       _          _                 ",
                    "b b  b                      _             ",
                    "bMb  b                           _        ",
                    "b    b M                             _    ",
                    "bbbbbb                                   P",
                    "#########################################b",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
                //Level 6
                [
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "b bM %               %           %     #b%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%b",
                    "b bMbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb_#b#######################################b",
                    "bAbM %   %   %   %   %   %   %   %   b_#bbb  bb  bb  bb  bb  bb  bb  bb  bb  bb b",
                    "bAb________________________________ Mb_#bb                                      b",
                    "bAb#################################Mb_#b    #   A   #   A   #   #   #   #   #  b",
                    "b#b %   %   %   %   %   %   %   %   Mb_#bMbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb b",
                    "bAb  b   b   b   b   b   b   b   b  Mb_ bMb%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%b b",
                    "b#b    #       #       #       #    Mb#_bMb b  bb  bb  bb  bb  bb  bb  bb  bb b b",
                    "bAb                                 Mb#   b                                     b",
                    "b                                   Mb# bbb bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "b       A   A   A   A   A   A   A   Mb# b% % % % % % % % % % % % % % % % % % % %b",
                    "bMbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb b## ####################################b",
                    "bMb                                 %   bb   b   b   b   b   b   b   b   b   b  b",
                    "bMb                                   b b                                       b",
                    "bMb&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&b b                                    b  b",
                    "b    # A # A # A # A # A # A # A # A #bPbA   A   A   A   A   A   A   A   A   bA@b",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
                //Level 7
                [
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "b    @b%       %           %           %    b",
                    "b  bbbb                                     b",
                    "b%    b     b                               b",
                    "bbbb  b     b                               b",
                    "b    %b     b     A       A       A       A b",
                    "b  bbbb & & b&& && && && && && && && && bbbbb",
                    "b%          bAAAAAAAAAAAAAAAAAAAAAAAAA      b",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb b",
                    "b M M M M M M M M M M M M M M M M M M M M M b",
                    "bM M M M M M M M M M M M M M M M M M M M M Mb",
                    "b M M M M M M M M M M M M M M M M M M M M M b",
                    "bM M M M M M M M M M M M M M M M M M M M M Mb",
                    "b%                                          b",
                    "b%    b          b         b          b    %b",
                    "b%                                          b",
                    "b%         b          b         b          %b",
                    "b%    _          _         _          _     b",
                    "b%    #          #         #          #    %b",
                    "b%         _          _         _           b",
                    "b%         #          #         #          %b",
                    "b%    _          _         _          _     b",
                    "b%    #          #         #          #    %b",
                    "b%         _          _         _           b",
                    "b%         #          #         #          %b",
                    "b%    _          _          _         _     b",
                    "b%    #          #          #         #    %b",
                    "b          _           _         _          b",
                    "b          #           #         #          b",
                    "b     _          _          _               b",
                    "b     #          #          #          A    b",
                    "b##bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb bbb",
                    "b##b%  %  %  %  %  %  %  %  %  %  %  %      b",
                    "bbbb                                        b",
                    "b                                        M  b",
                    "bMbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb######b",
                    "b& & & & & & & & & & & & & & & & & & bbbbbbbb",
                    "b   A   A   A   A   A   A   A   A       ####b",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb   bbbbb",
                    "b   b                                       b",
                    "b b b       #     #     #                   b",
                    "b#b                                         b",
                    "bM       A     A     A     A          M     b",
                    "b M bbbbbbbbbbbbbbbbbbbbbbbbbbb             b",
                    "bM                                          b",
                    "b M                                         b",
                    "bM                                          b",
                    "b M                                         b",
                    "b  ##   ##   ##   ##   ##   ##   ##   ##    b",
                    "b  bb   bb   bb   bb   bb   bb   bb   bb    b",
                    "b  %b   %b   %b   %b   %b   %b   %b   %% b Pb",
                    "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
            ];
            var happy = 0;
            if (happy === 0) {
                /* Variables */
                var playerSize = [20, 20];
                var pJumpHeight = 8;
                var playerColor = color(0, 235, 255);
                var grid = 30;
                // Don't change this stuff //
                /* More Variables */
                var level = 1; //Level#-1
                var keys = [];
                var transparence = 0;
                var redTrans = 0;
                var cam;
                /* Key interaction */
                keyPressed = function () {
                    keys[keyCode] = true;
                };
                keyReleased = function () {
                    keys[keyCode] = false;
                };
                var polygonCollide = function (shape1, shape2) {
                    var isBetween = function (c, a, b) {
                        return (a - c) * (b - c) <= 0;
                    };
                    /* Do ranges a and b overlap? */
                    var overlap = function (a, b) {
                        return isBetween(b.min, a.min, a.max) || isBetween(a.min, b.min, b.max);
                    };
                    /*
                     * Project shape onto axis.  Simply
                     * compute dot products between the
                     * shape's vertices and the axis, and
                     * keep track of the min and max values.
                     */
                    var project = function (shape, axis) {
                        var mn = Infinity;
                        var mx = -Infinity;
                        for (var i = 0; i < shape.length; i++) {
                            var dot = shape[i].x * axis.x + shape[i].y * axis.y;
                            mx = max(mx, dot);
                            mn = min(mn, dot);
                        }
                        return {
                            min: mn,
                            max: mx
                        };
                    };
                    /* Compute all projections axes of shape. */
                    var getAxes = function (shape) {
                        var axes = [];
                        for (var i = 0; i < shape.length; i++) {
                            var n = (i + 1) % shape.length;
                            /*
                             * The edge is simply the delta between i and n.
                             * The axis is the edge's normal. And a normal
                             * of (x, y) is either of (y, -x) or (-y, x).
                             */
                            axes[i] = {
                                y: shape[i].x - shape[n].x,
                                x: -(shape[i].y - shape[n].y)
                            };
                        }
                        return axes;
                    };
                    var shapes = [shape1, shape2];
                    for (var s = 0; s < shapes.length; s++) {
                        var axes = getAxes(shapes[s]);
                        for (var i = 0; i < axes.length; i++) {
                            var axis = axes[i];
                            /* Project both shapes onto this axis */
                            var p1 = project(shape1, axis);
                            var p2 = project(shape2, axis);
                            if (!overlap(p1, p2)) {
                                /* The two shapes cannot overlap */
                                return false;
                            }
                        }
                    }
                    return true; /* they overlap */
                };
                //for triangular collisions
                var Camera = function (x, y) {
                    this.x = x;
                    this.y = y;
                    this.w = width;
                    this.h = height;
                    this.view = function (player) {
                        this.x = player.x;
                        this.y = player.y;
                        this.x = constrain(this.x, this.w / 2, level_w - this.w / 2);
                        this.y = constrain(this.y, this.h / 2, level_h - this.h / 2);
                        translate(screen_width / 2 - this.x, screen_height / 2 - this.y);
                    };
                };
                var view = function (obj) {
                    return obj.x + screen_width / 2 - cam.x < width && obj.x + screen_width / 2 - cam.x > -obj.w &&
                        obj.y + screen_height / 2 - cam.y < height && obj.y + screen_height / 2 - cam.y > -obj.h;
                };
                var collide = function (obj1, obj2) {
                    return obj1.x < obj2.x + obj2.w && obj1.x + obj1.w > obj2.x &&
                        obj1.y < obj2.y + obj2.h && obj1.y + obj1.h > obj2.y;
                };
                var Player = function (x, y, w, h) {
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.speed = 0.5;
                    this.yvel = 0;
                    this.xvel = 0;
                    this.gravity = 0.3;
                    this.JH = pJumpHeight;
                    this.falling = false;
                    this.speedLimit = 5;
                    if (level === 0 || level === 1 || level === 2 || level === 3 || level === 4 || level === 5 || level === 6) {
                        this.fallLimit = 8;
                        this.health = 200; //health amount
                    }
                    this.dir = 0;
                    this.color = playerColor; //art stuff
                    this.dead = false;
                    this.deadTimer = 0;
                    this.update = function (blocks) {
                        this.sight = this.w / 4; //calculate the offset of the face based on the width of the player.
                        if (!this.dead) { //moving
                            if (keys[UP] && !this.falling) {
                                this.yvel = -this.JH;
                            }
                            if (keys[RIGHT]) {
                                this.xvel += this.speed;
                                this.dir += this.speed;
                            }
                            if (keys[LEFT]) {
                                this.xvel -= this.speed;
                                this.dir -= this.speed;
                            }
                        }
                        if (!keys[RIGHT] && !keys[LEFT]) {
                            if (this.dir > 0) {
                                this.dir -= this.speed;
                            }
                            if (this.dir < 0) {
                                this.dir += this.speed;
                            }
                            if (this.xvel > 0) {
                                this.xvel -= this.speed;
                            }
                            if (this.xvel < 0) {
                                this.xvel += this.speed;
                            }
                        }
                        this.dir = constrain(this.dir, -this.sight, this.sight);
                        this.xvel = constrain(this.xvel, -this.speedLimit, this.speedLimit);
                        if (this.yvel > this.fallLimit) {
                            this.yvel = this.fallLimit;
                        }
                        this.x = constrain(this.x, 0, level_w - this.w);
                        this.x += this.xvel;
                        this.applyCollision(blocks, this.xvel, 0); // apply speed and collisions
                        this.falling = true;
                        this.y += this.yvel;
                        this.applyCollision(blocks, 0, this.yvel);
                        this.yvel += this.gravity;
                        if (this.health <= 0) {
                            this.dead = true;
                        }
                        if (this.dead) {
                            this.deadTimer++;
                        }
                    };
                    this.draw = function () {
                        noStroke();
                        var d = (this.dir / this.w) * 15;
                        fill(this.color);
                        rect(this.x, this.y, this.w, this.h, (this.w + this.h) / 20);
                        this.eyeSize = (this.w + this.h) / 10;
                        fill(0);
                        ellipse(d + this.x + this.w / 3, this.y + this.h / 3, this.eyeSize, this.eyeSize);
                        ellipse(d + this.x + this.w * 2 / 3, this.y + this.h / 3, this.eyeSize, this.eyeSize);
                        noFill();
                        stroke(0);
                        strokeWeight(1);
                    };
                    this.applyCollision = function (obj, velx, vely) {
                        for (var i = 0; i < obj.length; i++) {
                            if (collide(this, obj[i]) && obj[i].solid) { // handle collisions
                                if (obj[i].type === "ice") {
                                    obj[i].melting = true;
                                } //make the ice blocks start melting
                                if (vely > 0) {
                                    this.yvel = 0;
                                    this.falling = false;
                                    this.y = obj[i].y - this.h;
                                }
                                if (vely < 0) {
                                    this.yvel = 0;
                                    this.falling = true;
                                    this.y = obj[i].y + obj[i].h;
                                }
                                if (velx < 0) {
                                    this.xvel = 0;
                                    this.x = obj[i].x + obj[i].w;
                                }
                                if (velx > 0) {
                                    this.xvel = 0;
                                    this.x = obj[i].x - this.w;
                                }
                            }
                        }
                    };
                    this.healthBar = function () {
                        textSize(14);
                        fill(255);
                        rect(20, 20, 100, 15);
                        fill(255, 0, 0);
                        rect(20, 20, this.health, 15);
                        fill(0);
                        textAlign(CENTER, CENTER);
                        text("Health " + max(0, round(this.health)) + "%", 70, 20 + 15 / 2);
                        if (level === 0 || level === 1 || level === 2 || level === 3 || level === 4 || level === 5 || level === 6) {
                            this.health = constrain(this.health, 0, Infinity); //Health Limit
                        }
                    };
                };
                var player = new Player(200, 100, playerSize[0], playerSize[1]);
                /* Blocks */
                var Block = function (x, y, w, h, type, i) {
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.isImage = i;
                    this.type = type;
                    this.melting = false;
                    this.solid = true;
                    this.op = 255;
                    this.draw = function () {
                        if (view(this)) {
                            switch (this.type) {
                                case "solid":
                                case "moving":
                                    noStroke();
                                    fill(255);
                                    rect(this.x, this.y, this.w, this.h);
                                    break;
                                case "ice":
                                    strokeWeight(2);
                                    stroke(255, 255, 255, this.op);
                                    fill(150, 207, 245, this.op);
                                    rect(this.x + 1, this.y + 1, this.w - 2, this.h - 2);
                                    break;
                            }
                        }
                    };
                    this.update = function () {
                        if (this.type === "ice") {
                            if (this.melting) {
                                this.op -= 2;
                            }
                            if (this.op < 50) {
                                this.solid = false;
                            }
                            if (this.op < -120) {
                                this.op = 255;
                                this.melting = false;
                                this.solid = true;
                            }
                        }
                    };
                };
                var blocks = [];
                blocks.add = function (x, y, w, h, t) {
                    this.push(new Block(x, y, w, h, t));
                };
                blocks.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        this[i].draw();
                        this[i].update();
                    }
                };
                /* Portal */
                var Goal = function (x, y, radius, i) {
                    this.x = x;
                    this.y = y;
                    this.w = radius;
                    this.h = radius;
                    this.isImage = i;
                    this.timer = 0;
                    this.complete = false;
                    this.color = 0;
                    this.draw = function () {
                        if (view(this)) {
                            colorMode(HSB);
                            noStroke();
                            for (var i = 0; i < this.w / 2; i += 2) {
                                fill(255, 0, 255, i * 10);
                                ellipse(this.x + this.w / 2, this.y + this.h / 2, this.w - i * 2, this.h - i * 2);
                            }
                            noFill();
                            strokeWeight(2);
                            for (var i = 0; i < this.w / 2; i += 2) {
                                this.opacity = (sin(i * frameCount) * 70);
                                stroke(frameCount % 255, 255, 255, this.opacity);
                                ellipse(this.x + this.w / 2, this.y + this.h / 2, this.w - i * 2, this.h - i * 2);
                            }
                            colorMode(RGB);
                        }
                    };
                    this.update = function () {
                        if (collide(this, player)) {
                            transparence += 5;
                        }
                        if (transparence >= 250) {
                            this.complete = true;
                        }
                    };
                };
                var portals = [];
                portals.add = function (x, y, r) {
                    this.push(new Goal(x, y, r));
                };
                portals.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        this[i].draw();
                        this[i].update();
                    }
                };
                /* Lava */
                var Lava = function (x, y, s, i) {
                    this.x = x;
                    this.y = y;
                    this.w = s;
                    this.h = s;
                    this.s = (s / 3);
                    this.isImage = i;
                    this.draw = function () {
                        if (view(this)) {
                            noStroke();
                            for (var x = 0; x < this.w; x += this.s) {
                                for (var y = 0; y < this.h; y += this.s) {
                                    fill(random(100, 200), 0, 0);
                                    rect(this.x + x, this.y + y, this.s, this.s);
                                }
                            }
                        }
                    };
                    this.update = function () {
                        if (collide(this, player)) {
                            player.health -= 2;
                            redTrans = 80;
                        }
                    };
                };
                var lava = [];
                lava.add = function (x, y, s) {
                    this.push(new Lava(x, y, s));
                };
                lava.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        this[i].draw();
                        this[i].update();
                    }
                };
                /* Spikes */
                var Spike = function (x, y, w, h, i) {
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.isImage = i;
                    this.draw = function () {
                        if (view(this)) {
                            noStroke();
                            fill(120);
                            triangle(this.x + this.w / 2, this.y, this.x, this.y + this.h, this.x + this.w, this.y + this.h);
                        }
                    };
                    this.update = function () {
                        if (polygonCollide([{
                            x: player.x,
                            y: player.y
                        },
                        {
                            x: player.x + player.w,
                            y: player.y
                        },
                        {
                            x: player.x + player.w,
                            y: player.y + player.h
                        },
                        {
                            x: player.x,
                            y: player.y + player.h
                        }
                        ], //the player
                            [{
                                x: this.x + this.w / 2,
                                y: this.y
                            },
                            {
                                x: this.x,
                                y: this.y + this.h
                            },
                            {
                                x: this.x + this.w,
                                y: this.y + this.h
                            }
                            ])) {
                            player.yvel = -player.JH;
                            player.health -= 5;
                            redTrans = 80; //red flash
                        }
                    };
                };
                var spikes = [];
                spikes.add = function (x, y, s) {
                    this.push(new Spike(x, y, s, s));
                };
                spikes.apply = function () {
                    for (var i = 0; i < spikes.length; i++) {
                        this[i].draw();
                        this[i].update();
                    }
                };
                /* Jumpblocks */
                var JumpBlock = function (x, y, w, h, i) {
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.isImage = i;
                    this.draw = function () {
                        if (view(this)) {
                            noStroke();
                            fill(255, 71, 169);
                            rect(this.x, this.y, this.w, this.h);
                        }
                    };
                    this.update = function () {
                        if (collide(this, player)) {
                            player.yvel = -player.JH * 1.3;
                        }
                    };
                };
                var jumpBlocks = [];
                jumpBlocks.add = function (x, y, w, h) {
                    this.push(new JumpBlock(x, y, w, h));
                };
                jumpBlocks.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        this[i].draw();
                        this[i].update();
                    }
                };
                /* Bullets+Cannons */
                var Bullet = function (x, y, s, angle) {
                    this.x = x;
                    this.y = y;
                    this.w = s;
                    this.h = s;
                    this.deleted = false;
                    this.angle = angle;
                    this.draw = function () {
                        if (!this.deleted) {
                            noStroke();
                            fill(50);
                            ellipseMode(CORNER);
                            ellipse(this.x, this.y, this.w, this.h);
                            ellipseMode(CENTER);
                        }
                    };
                    this.update = function () {
                        this.x += cos(this.angle) * 2;
                        this.y += sin(this.angle) * 2;
                        if (collide(this, player) && !this.deleted && !player.dead) {
                            this.deleted = true;
                            player.health -= 5;
                            redTrans = 80;
                        }
                        for (var i = 0; i < blocks.length; i++) {
                            if (collide(this, blocks[i]) && !this.deleted) {
                                this.deleted = true;
                            }
                        }
                    };
                };
                var bullets = [];
                bullets.add = function (x, y, angle) {
                    this.push(new Bullet(x, y, 5, angle));
                };
                bullets.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        bullets[i].draw();
                        bullets[i].update();
                        if (bullets[i].deleted) {
                            bullets.splice(i, 1);
                        }
                    }
                };
                var Cannon = function (x, y, w, h) {
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.angle = atan2(this.x - player.x, player.y - this.y);
                    this.bullets = [];
                    this.draw = function () {
                        if (view(this)) {
                            noStroke();
                            fill(80);
                            ellipse(this.x + this.w / 2, this.y + this.h / 2, this.w * 3 / 5, this.h * 3 / 5);
                            pushMatrix();
                            translate(this.x + this.w / 2, this.y + this.h / 2);
                            rotate(this.angle);
                            rect(-5, 5, this.w / 3, 10);
                            popMatrix();
                        }
                    };
                    this.update = function () {
                        this.angle = atan2(this.x - player.x, player.y - this.y);
                        if ((frameCount % 100) === 99) {
                            bullets.add(this.x + this.w / 2, this.y + this.h / 2, this.angle + 90);
                        }
                    };
                };
                var cannons = [];
                cannons.add = function (x, y, s) {
                    this.push(new Cannon(x, y, s, s));
                };
                cannons.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        this[i].draw();
                        this[i].update();
                    }
                };
                /* Monster */
                var Monster = function (x, y, w, h) {
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.dead = false; // is the monster "dead"?
                    this.xvel = 1; // monster's speed
                    this.angle = 0; // the monster's eye's angle
                    this.draw = function () {
                        if (view(this) && !this.dead) {
                            // draw the monster
                            fill(23, 130, 57);
                            noStroke();
                            rect(this.x, this.y, this.w, this.h, Math.abs(cos(frameCount * 2)) * 10); // main body
                            fill(255, 255, 255);
                            stroke(0);
                            ellipse(this.x + this.w / 2, this.y + this.h / 2, this.w / 2, this.h / 2); // the white of the eye
                            // the pupil
                            pushMatrix();
                            translate(this.x + this.w / 2, this.y + this.h / 2);
                            rotate(this.angle + 40);
                            fill(0, 0, 0);
                            ellipseMode(CORNER);
                            ellipse(0, 0, this.w / 5, this.h / 5);
                            ellipseMode(CENTER);
                            popMatrix();
                        }
                    };
                    this.update = function () {
                        if (!this.dead) {
                            this.angle = atan2(this.x - player.x, player.y - this.y); //make the angle point to the player
                            this.x += this.xvel;
                            for (var i = 0; i < blocks.length; i++) {
                                if (collide(this, blocks[i])) {
                                    this.xvel = -this.xvel;
                                }
                            }
                            if (collide(this, player)) {
                                if (!player.falling && !this.dead && !player.dead) {
                                    player.health -= 1;
                                    redTrans = 80;
                                } else if (player.yvel > 0 && player.falling) {
                                    this.dead = true; // the monster is "dead"
                                    player.yvel = -player.JH; // make the player hop
                                }
                            }
                        }
                    };
                };
                var monsters = [];
                monsters.add = function (x, y, w, h) {
                    this.push(new Monster(x, y, w, h));
                };
                monsters.apply = function () {
                    for (var i = 0; i < this.length; i++) {
                        this[i].update();
                        this[i].draw();
                        if (this[i].dead) {
                            this.splice(i, 1);
                        }
                    }
                };
                /* Manage objects in the game */
                var objects = [blocks, portals, lava, spikes, jumpBlocks, cannons, bullets, monsters];
                objects.remove = function () {
                    for (var i = 0; i < objects.length; i++) {
                        for (var j = 0; j < objects[i].length; j++) {
                            objects[i].splice(j, objects[i].length);
                        }
                    }
                };
                var updateMap = function () {
                    objects.remove();
                    for (var col = 0; col < levels[level].length; col++) {
                        var cells = levels[level][col];
                        for (var row = 0; row < cells.length; row++) {
                            switch (cells[row]) {
                                case "b":
                                    blocks.add(row * grid, col * grid, grid, grid, "solid");
                                    break;
                                case "@":
                                    portals.add(row * grid, col * grid, grid);
                                    break;
                                case "_":
                                    blocks.add(row * grid, col * grid + (grid / 3) * 2, grid * 2, grid / 3, "ice");
                                    break;
                                case "#":
                                    lava.add(row * grid, col * grid, grid, grid);
                                    break;
                                case "P":
                                    player = new Player(row * grid - (player.w - grid) / 2, col * grid - (player.h - grid) / 2, playerSize[0], playerSize[1]);
                                    break;
                                case "A":
                                    spikes.add(row * grid, col * grid, grid, grid);
                                    break;
                                case "M":
                                    jumpBlocks.add(row * grid, col * grid + grid * 2 / 3, grid, grid / 3);
                                    break;
                                case "%":
                                    cannons.add(row * grid, col * grid, grid);
                                    break;
                                case "&":
                                    monsters.add(row * grid, col * grid, grid, grid);
                                    break;
                            }
                            level_w = levels[level][col].length * grid;
                            level_h = levels[level].length * grid;
                        }
                    }
                };
                var resetCam = function () {
                    cam.x = player.x;
                    cam.y = player.y;
                }; //reset the cam to the player's location.
                var applyGame = function () {
                    blocks.apply();
                    portals.apply();
                    if (!player.dead) {
                        player.draw();
                    }
                    lava.apply();
                    spikes.apply();
                    jumpBlocks.apply();
                    monsters.apply();
                    bullets.apply();
                    cannons.apply();
                    player.update(blocks);
                };
                /* Update map */
                updateMap();
                var cam = new Camera(player.x, player.y);
                var draw = function () {
                    background(200);
                    pushMatrix();
                    cam.view(player);
                    applyGame();
                    popMatrix();
                    player.healthBar();
                    if (player.deadTimer > 100) {
                        updateMap();
                        resetCam();
                    }
                    if (portals[0]) {
                        if (portals[0].complete) {
                            if (level < 7) {
                                level++;
                                updateMap();
                                resetCam();
                            } else {
                                background(0, 0, 0);
                                fill(255);
                                textSize(20);
                                transparence = 0;
                                text("Congratulations!\nYou've finished all the levels!", 200, 200);
                            }
                        }
                    }
                    //@transparency
                    {
                        fill(255, 255, 255, transparence);
                        noStroke();
                        rect(0, 0, width, height);
                        fill(255, 0, 0, redTrans);
                        rect(0, 0, width, height);
                        transparence -= 3;
                        redTrans -= 3;
                        transparence = constrain(transparence, 0, 255);
                        redTrans = constrain(redTrans, 0, 255);
                    }
                    //background(255);
                };
            }
        }
    };
    // Get the canvas that ProcessingJS will use
    var canvas = document.getElementById("mycanvas");
    // Pass the function to ProcessingJS constructor
    var processingInstance = new Processing(canvas, programCode);
</script>

</html>